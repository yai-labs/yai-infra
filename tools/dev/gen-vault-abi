#!/usr/bin/env python3
import argparse
import json
from datetime import datetime, timezone
from pathlib import Path


def upper_snake(value: str) -> str:
    out = []
    for ch in value:
        if ch.isalnum():
            out.append(ch.upper())
        else:
            out.append("_")
    return "".join(out)


def pascal_case(value: str) -> str:
    parts = []
    buf = []
    for ch in value:
        if ch.isalnum():
            buf.append(ch)
        else:
            if buf:
                parts.append("".join(buf))
                buf = []
    if buf:
        parts.append("".join(buf))
    return "".join(part[:1].upper() + part[1:] for part in parts if part)


def render_header(spec: dict, generated: str) -> str:
    header = spec["header"]
    lines = [
        "/* SPDX-License-Identifier: Apache-2.0 */",
        "/* AUTO-GENERATED: vault/vault_abi.json */",
        f"/* Generated: {generated} */",
        "/**",
        " * @file yai_vault_abi.h",
        " * @brief Vault ABI offsets and constants (generated from schema).",
        " */",
        "#ifndef YAI_VAULT_ABI_H",
        "#define YAI_VAULT_ABI_H",
        "",
        f"#define YAI_VAULT_ABI_VERSION {spec['version']}",
        f"#define YAI_VAULT_LAYOUT_BYTES {spec['layout_bytes']}",
        f"#define YAI_VAULT_HEADER_SIZE {header['size']}",
        "",
    ]
    for field in header["fields"]:
        name = upper_snake(field["name"])
        lines.append(f"#define YAI_VAULT_OFF_{name} {field['offset']}")
    lines.extend(["", "#endif", ""])
    return "\n".join(lines)


def render_law_ids(spec: dict, generated: str) -> str:
    header = spec["header"]
    lines = [
        "\\* AUTO-GENERATED: vault/vault_abi.json",
        f"\\* Generated: {generated}",
        "---- MODULE LAW_IDS ----",
        f"VaultAbiVersion == {spec['version']}",
        f"VaultLayoutBytes == {spec['layout_bytes']}",
        f"VaultHeaderSize == {header['size']}",
    ]
    for field in header["fields"]:
        name = pascal_case(field["name"])
        lines.append(f"Off{name} == {field['offset']}")
    lines.append("====")
    lines.append("")
    return "\n".join(lines)


def main() -> int:
    root = Path(__file__).resolve().parent.parent.parent
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--spec",
        default=str(root / "deps/yai-specs/specs/vault/schema/vault_abi.json"),
        help="Path to vault ABI spec JSON",
    )
    parser.add_argument(
        "--out-dir",
        default=str(root),
        help="Output root directory",
    )
    args = parser.parse_args()

    spec_path = Path(args.spec)
    out_dir = Path(args.out_dir)
    with spec_path.open("r", encoding="utf-8") as handle:
        spec = json.load(handle)

    generated = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
    header_text = render_header(spec, generated)
    law_text = render_law_ids(spec, generated)

    header_path = out_dir / "deps/yai-specs/specs/vault/include/yai_vault_abi.h"
    law_path = out_dir / "deps/yai-specs/formal/tla/LAW_IDS.tla"
    header_path.parent.mkdir(parents=True, exist_ok=True)
    law_path.parent.mkdir(parents=True, exist_ok=True)
    header_path.write_text(header_text, encoding="utf-8")
    law_path.write_text(law_text, encoding="utf-8")

    return 0


if __name__ == "__main__":
    raise SystemExit(main())
