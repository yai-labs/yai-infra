#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
VERSION_FILE="$ROOT/tools/VERSION"

usage() {
  cat <<'USAGE'
Usage:
  tools/bin/yai-version [--json]

Outputs the canonical yai-infra toolkit version.
USAGE
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

if [[ ! -f "$VERSION_FILE" ]]; then
  echo "ERROR: missing tools/VERSION" >&2
  exit 2
fi

version="$(tr -d '[:space:]' < "$VERSION_FILE")"
commit="$(git -C "$ROOT" rev-parse --short HEAD 2>/dev/null || true)"

if [[ "${1:-}" == "--json" ]]; then
  printf '{"toolkit":"yai-infra","version":"%s","commit":"%s"}\n' "$version" "$commit"
  exit 0
fi

printf 'yai-infra toolkit %s' "$version"
if [[ -n "$commit" ]]; then
  printf ' (%s)' "$commit"
fi
printf '\n'
