#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
WORKSPACE_ROOT="$(cd "${ROOT}/.." && pwd)"

usage() {
  cat <<'EOF'
Usage:
  tools/bin/yai-dev-branch-sync [--name <branch>] [--repos yai,yai-cli,yai-mind] [--dry-run] [branch-args...]

If --name is omitted, branch name is generated via tools/bin/yai-branch using branch-args.
Examples:
  tools/bin/yai-dev-branch-sync --name chore/na-bootstrap-governance-proof-pack-lock
  tools/bin/yai-dev-branch-sync --type chore --issue N/A --reason bootstrap --area governance --desc proof-pack-lock
EOF
}

BRANCH_NAME=""
REPOS_CSV="yai,yai-cli,yai-mind"
DRY_RUN=0
BRANCH_ARGS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --name)
      BRANCH_NAME="${2:-}"
      shift 2
      ;;
    --repos)
      REPOS_CSV="${2:-}"
      shift 2
      ;;
    --dry-run)
      DRY_RUN=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      BRANCH_ARGS+=("$1")
      shift
      ;;
  esac
done

if [[ -z "${BRANCH_NAME}" ]]; then
  if [[ ${#BRANCH_ARGS[@]} -eq 0 ]]; then
    echo "[branch-sync] ERROR: provide --name or branch args for yai-branch" >&2
    usage
    exit 2
  fi
  BRANCH_NAME="$("${ROOT}/tools/bin/yai-branch" "${BRANCH_ARGS[@]}")"
fi

IFS=',' read -r -a REPOS <<< "$REPOS_CSV"

echo "[branch-sync] branch=${BRANCH_NAME}"
echo "[branch-sync] repos=${REPOS_CSV}"

for repo in "${REPOS[@]}"; do
  repo="${repo// /}"
  [[ -n "$repo" ]] || continue

  repo_path="${WORKSPACE_ROOT}/${repo}"
  if [[ ! -d "$repo_path/.git" ]]; then
    echo "[branch-sync] ERROR: not a git repo: ${repo_path}" >&2
    exit 2
  fi

  current="$(git -C "$repo_path" rev-parse --abbrev-ref HEAD)"
  exists="$(git -C "$repo_path" branch --list "$BRANCH_NAME")"

  if [[ $DRY_RUN -eq 1 ]]; then
    if [[ -n "$exists" ]]; then
      echo "[branch-sync] ${repo}: checkout existing ${BRANCH_NAME} (from ${current})"
    else
      echo "[branch-sync] ${repo}: create+checkout ${BRANCH_NAME} (from ${current})"
    fi
    continue
  fi

  if [[ -n "$exists" ]]; then
    git -C "$repo_path" checkout "$BRANCH_NAME" >/dev/null
    echo "[branch-sync] ${repo}: checked out existing ${BRANCH_NAME}"
  else
    git -C "$repo_path" checkout -b "$BRANCH_NAME" >/dev/null
    echo "[branch-sync] ${repo}: created ${BRANCH_NAME}"
  fi
done
