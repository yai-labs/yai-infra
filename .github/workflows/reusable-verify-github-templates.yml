name: reusable-verify-github-templates

on:
  workflow_call:
    inputs:
      org:
        description: Organization/owner context for governance suite.
        required: false
        type: string
        default: "yai-labs"
      project_number:
        description: Project number context for governance suite.
        required: false
        type: number
        default: 0
      repo_scope:
        description: Repository scope selector (reserved for future use).
        required: false
        type: string
        default: ""
      dry_run:
        description: If true, print drift diff without failing.
        required: false
        type: boolean
        default: false
      infra_repo:
        required: false
        type: string
        default: yai-labs/yai-infra
      infra_ref:
        required: false
        type: string
        default: main
    secrets:
      project_token:
        required: false

jobs:
  verify-template-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout consumer repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout infra canonical templates
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.infra_repo }}
          ref: ${{ inputs.infra_ref }}
          path: .infra-canonical
          fetch-depth: 1

      - name: Compare GitHub templates with infra canonical
        shell: bash
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          set -euo pipefail
          CANONICAL_ROOT=".infra-canonical/governance/templates/github"

          check_path() {
            local rel="$1"
            local src="${CANONICAL_ROOT}/${rel}"
            local dst="${rel}"
            if [[ ! -e "$src" ]]; then
              echo "Canonical template path missing in infra: $rel" >&2
              exit 1
            fi
            if [[ ! -e "$dst" ]]; then
              echo "Consumer template path missing: $rel" >&2
              exit 1
            fi
            if ! diff -ruN "$src" "$dst" > /tmp/template-diff.txt; then
              echo "Template drift detected for: $rel" >&2
              cat /tmp/template-diff.txt >&2
              if [[ "${DRY_RUN}" == "true" ]]; then
                echo "dry_run=true: drift reported without failure"
                return 0
              fi
              exit 1
            fi
          }

          check_path ".github/ISSUE_TEMPLATE"
          check_path ".github/PULL_REQUEST_TEMPLATE"
          check_path ".github/PULL_REQUEST_TEMPLATE.md"
          check_path ".github/labeler.yml"
          check_path ".github/.managed-by-yai-infra"

          echo "GitHub templates are aligned with infra canonical."
