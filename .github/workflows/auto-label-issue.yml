name: auto-label-issue

on:
  issues:
    types: [opened, edited, reopened]

permissions:
  contents: read
  issues: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Apply semantic labels to issues
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            if (!issue) return;

            const specs = [
              { name: "type:docs", color: "0e8a16", description: "Documentation changes" },
              { name: "type:ci", color: "5319e7", description: "CI/workflow changes" },
              { name: "type:tooling", color: "1d76db", description: "Tooling/scripts/schemas changes" },
              { name: "type:migration", color: "fbca04", description: "Migration/cutover/stabilization changes" },
              { name: "type:governance", color: "d93f0b", description: "Governance/project/policy changes" },
              { name: "track:release-hardening", color: "b60205", description: "Release hardening track" },
            ];
            for (const spec of specs) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: spec.name,
                });
              } catch (err) {
                if (err.status !== 404) throw err;
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: spec.name,
                  color: spec.color,
                  description: spec.description,
                });
              }
            }

            const text = `${issue.title || ""}\n${issue.body || ""}`.toLowerCase();
            const labels = new Set();

            if (/\bci\b|workflow|github actions?|pipeline/.test(text)) labels.add("type:ci");
            if (/docs?|runbook|migration|governance|policy/.test(text)) labels.add("type:docs");
            if (/tools?|script|schema|lint|verify/.test(text)) labels.add("type:tooling");
            if (/migration|cutover|rollback|stabilization/.test(text)) labels.add("type:migration");
            if (/governance|policy|project field|milestone|epic|sub-issue/.test(text)) labels.add("type:governance");
            if (!Array.from(labels).some((l) => l.startsWith("track:"))) labels.add("track:release-hardening");

            if (labels.size === 0) return;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              labels: Array.from(labels),
            });
